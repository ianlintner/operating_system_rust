name: Build and Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Rust nightly
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: nightly
        override: true
        components: rust-src, llvm-tools-preview
    
    - name: Install bootimage
      run: cargo install bootimage
    
    - name: Build kernel
      run: cargo build --verbose
      
    - name: Build bootable image
      run: cargo bootimage
      
    - name: Install QEMU
      run: sudo apt-get update && sudo apt-get install -y qemu-system-x86
      
    - name: Test boot (quick smoke test)
      run: |
        timeout 3s qemu-system-x86_64 \
          -drive format=raw,file=target/x86_64-unknown-none/debug/bootimage-operating_system_rust.bin \
          -nographic \
          -serial stdio || echo "Boot test completed"
